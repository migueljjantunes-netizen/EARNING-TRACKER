<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Report Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
            indigo: { 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
            emerald: { 500: '#10b981', 600: '#059669' },
            red: { 500: '#ef4444', 600: '#dc2626' },
            amber: { 500: '#f59e0b', 600: '#d97706' },
            purple: { 500: '#a855f7' },
            green: { 500: '#22c55e' },
            sky: { 500: '#0ea5e9' }
          }
        }
      }
    };
  </script>
  <style>
    body { font-feature-settings: "liga" 1; }
    #autocomplete-list {
      position: absolute; z-index: 10; background: white; border: 1px solid #cbd5e1;
      border-top: none; max-height: 200px; overflow-y: auto; width: 100%;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px;
    }
    .autocomplete-item {
      padding: 10px 12px; cursor: pointer; transition: background 0.15s;
    }
    .autocomplete-item:hover, .autocomplete-item.selected {
      background-color: #e0f2fe;
    }
    .tag-badge {
      display: inline-block; padding: 3px 8px; font-size: 0.7rem; border-radius: 999px;
      margin-right: 4px; margin-top: 2px; color: white; font-weight: 500;
    }
    .tag-cloud {
      display: flex; flex-wrap: wrap; gap: 8px;
    }
    .tag-cloud-item {
      padding: 6px 12px; border-radius: 999px; font-size: 0.85rem; cursor: pointer;
      transition: all 0.2s; font-weight: 500; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tag-cloud-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }
    .edit-form {
      background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 12px;
      border: 2px solid #cbd5e1;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 20px;
      color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .company-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .company-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
    .sync-status {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      gap: 6px;
    }
    .sync-status.synced { background: #dcfce7; color: #166534; }
    .sync-status.syncing { background: #fef3c7; color: #92400e; }
    .sync-status.error { background: #fee2e2; color: #991b1b; }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinning {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 flex flex-col items-center p-4 sm:p-6 lg:p-8 font-sans antialiased">
  <div id="app" class="w-full max-w-7xl">

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full flex items-center justify-center p-4 backdrop-blur-sm">
      <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md mx-auto">
        <h3 class="text-xl leading-6 font-bold text-gray-900 mb-2">Notification</h3>
        <div class="mt-3">
          <p id="modal-message" class="text-sm text-gray-600"></p>
        </div>
        <div class="mt-6 flex justify-center space-x-3">
          <button id="confirm-delete" type="button" class="inline-flex justify-center rounded-lg border border-transparent bg-red-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">Delete</button>
          <button id="cancel-delete" type="button" class="inline-flex justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">Cancel</button>
          <button id="modal-ok" type="button" class="inline-flex justify-center rounded-lg border border-transparent bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">OK</button>
        </div>
      </div>
    </div>

    <!-- GitHub Setup Modal -->
    <div id="setup-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full flex items-center justify-center p-4 backdrop-blur-sm">
      <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg mx-auto">
        <h3 class="text-2xl font-bold text-gray-900 mb-4">GitHub Gist Setup</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">GitHub Personal Access Token</label>
            <input type="password" id="github-token" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ghp_..."/>
            <p class="text-xs text-slate-500 mt-2">Create at: <a href="https://github.com/settings/tokens/new" target="_blank" class="text-indigo-600 hover:underline">github.com/settings/tokens</a> (needs 'gist' scope)</p>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Gist ID (optional - leave empty to create new)</label>
            <input type="text" id="gist-id" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="abc123..."/>
          </div>
          <div class="flex gap-3 mt-6">
            <button id="save-github-config" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">Save & Sync</button>
            <button id="cancel-setup" class="flex-1 bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-6">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
          <h1 class="text-4xl sm:text-5xl font-extrabold text-slate-900 mb-2">üìä Report Tracker</h1>
          <p class="text-sm sm:text-base text-slate-600">Track financial documents ‚Ä¢ Click to edit ‚Ä¢ Color-coded tags</p>
        </div>
        <div class="flex items-center gap-4 w-full lg:w-auto">
          <div class="stat-card flex-1 lg:flex-none">
            <div class="text-sm opacity-90 mb-1">Total Reports</div>
            <div id="total-count" class="text-4xl font-extrabold">0</div>
          </div>
          <div class="flex flex-col gap-2">
            <span id="sync-status" class="sync-status synced">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Local Mode
            </span>
            <button id="setup-github-btn" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition-colors whitespace-nowrap">
              üîß Setup GitHub Sync
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Add Report & Last 3 & Tag Cloud -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Add Report -->
      <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-2xl font-bold text-slate-800 mb-5">üìù Add New Report</h2>
        <form id="addReportForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end relative">
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Company Name</label>
            <input type="text" id="companyName" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="e.g., Apple Inc." autocomplete="off"/>
            <div id="autocomplete-list" class="hidden"></div>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Report/Release Title</label>
            <input type="text" id="reportTitle" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="e.g., Q3 2024 Earnings Report" autocomplete="off"/>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Tags (comma-separated)</label>
            <input type="text" id="reportTags" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all" placeholder="e.g., earnings, special call"/>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Date Read</label>
            <input type="date" id="dateRead" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"/>
          </div>
          <div>
            <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all duration-200 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
              </svg>
              Add Report
            </button>
          </div>
        </form>
      </div>

      <!-- Last 3 + Tag Cloud -->
      <div class="space-y-6">
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h2 class="text-xl font-bold text-slate-800 mb-4">üïê Recent Reports</h2>
          <div id="last-three-container" class="space-y-3">
            <p class="text-slate-500 text-sm">No recent reports found.</p>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h2 class="text-xl font-bold text-slate-800 mb-4">üè∑Ô∏è Tag Cloud</h2>
          <div id="tag-cloud" class="tag-cloud">
            <!-- filled by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Main Display Area -->
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 flex-wrap">
        <h2 id="main-title" class="text-2xl font-bold text-slate-800">üìÅ Your Companies</h2>
        <div class="flex items-center gap-3 flex-wrap">
          <button id="toggle-all" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-1.5 rounded-lg hover:bg-indigo-50">Show All Reports</button>
          <button id="export-json" class="flex items-center text-sm font-semibold text-green-600 hover:text-green-800 transition-colors px-3 py-1.5 rounded-lg hover:bg-green-50">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-1.5">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
          </button>
          <button id="import-json" class="flex items-center text-sm font-semibold text-amber-600 hover:text-amber-800 transition-colors px-3 py-1.5 rounded-lg hover:bg-amber-50">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-1.5">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Import
          </button>
        </div>
      </div>
      <div id="main-display" class="mt-4">
        <!-- filled by JS -->
      </div>
    </div>
  </div>

  <input type="file" id="import-file" accept=".json" class="hidden">

  <script>
    // ========== GITHUB GIST STORAGE ==========
    class GistStorage {
      constructor() {
        this.token = localStorage.getItem('github_token') || '';
        this.gistId = localStorage.getItem('gist_id') || '';
        this.syncEnabled = this.token && this.gistId;
      }

      async loadFromGist() {
        if (!this.syncEnabled) return null;
        
        try {
          updateSyncStatus('syncing', 'Syncing...');
          const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
            headers: {
              'Authorization': `token ${this.token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });

          if (!response.ok) throw new Error('Failed to fetch gist');

          const gist = await response.json();
          const content = gist.files['reports.json']?.content;
          
          if (content) {
            updateSyncStatus('synced', 'Synced');
            return JSON.parse(content);
          }
          return null;
        } catch (error) {
          console.error('Load error:', error);
          updateSyncStatus('error', 'Sync Error');
          return null;
        }
      }

      async saveToGist(reports) {
        if (!this.syncEnabled) return false;

        try {
          updateSyncStatus('syncing', 'Syncing...');
          
          const response = await fetch(`https://api.github.com/gists${this.gistId ? '/' + this.gistId : ''}`, {
            method: this.gistId ? 'PATCH' : 'POST',
            headers: {
              'Authorization': `token ${this.token}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              description: 'Financial Report Tracker Data',
              public: false,
              files: {
                'reports.json': {
                  content: JSON.stringify(reports, null, 2)
                }
              }
            })
          });

          if (!response.ok) throw new Error('Failed to save gist');

          const gist = await response.json();
          
          if (!this.gistId) {
            this.gistId = gist.id;
            localStorage.setItem('gist_id', gist.id);
          }

          updateSyncStatus('synced', 'Synced');
          return true;
        } catch (error) {
          console.error('Save error:', error);
          updateSyncStatus('error', 'Sync Error');
          return false;
        }
      }

      configure(token, gistId) {
        this.token = token;
        this.gistId = gistId;
        localStorage.setItem('github_token', token);
        if (gistId) localStorage.setItem('gist_id', gistId);
        this.syncEnabled = !!token;
      }

      disconnect() {
        localStorage.removeItem('github_token');
        localStorage.removeItem('gist_id');
        this.token = '';
        this.gistId = '';
        this.syncEnabled = false;
        updateSyncStatus('synced', 'Local Mode');
      }
    }

    const gistStorage = new GistStorage();

    function updateSyncStatus(state, text) {
      const statusEl = document.getElementById('sync-status');
      statusEl.className = `sync-status ${state}`;
      
      let icon = '';
      if (state === 'synced') {
        icon = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>';
      } else if (state === 'syncing') {
        icon = '<svg class="spinning" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>';
      } else if (state === 'error') {
        icon = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
      }
      
      statusEl.innerHTML = `${icon} ${text}`;
    }

    // ========== TAG COLOR MAP ==========
    const TAG_COLORS = {
      'earnings': 'bg-indigo-500',
      'special call': 'bg-emerald-500',
      'm&a': 'bg-red-500',
      'governance': 'bg-amber-500',
      'guidance': 'bg-purple-500',
      'esg': 'bg-green-500'
    };

    function getTagColor(tag) {
      const key = tag.toLowerCase();
      return TAG_COLORS[key] || 'bg-slate-500';
    }

    // ========== AUTO-TAG ==========
    function autoTag(title) {
      const lower = title.toLowerCase();
      const tags = [];
      if (lower.includes('special call')) tags.push('special call');
      if (lower.includes('m&a') || lower.includes('merger') || lower.includes('acquisition')) tags.push('M&A');
      if (/[qhq]\d/.test(lower) || lower.includes('ts') || lower.includes('fy')) tags.push('earnings');
      if (lower.includes('letter') || lower.includes('board') || lower.includes('governance')) tags.push('governance');
      if (lower.includes('guidance')) tags.push('guidance');
      if (lower.includes('esg') || lower.includes('sustainability')) tags.push('ESG');
      return [...new Set(tags)];
    }

    // ========== PRELOADED REPORTS ==========
    const PRELOADED_REPORTS = [
      { companyName: "HERMES", title: "25H1", dateRead: "2025-09-15", tags: autoTag("25H1") },
      { companyName: "ORACLE", title: "26Q1", dateRead: "2025-09-15", tags: autoTag("26Q1") },
      { companyName: "NAVIGATOR", title: "25Q2", dateRead: "2025-09-15", tags: autoTag("25Q2") },
      { companyName: "OLD REPUBLIC INTERNATIONAL", title: "25Q2", dateRead: "2025-09-02", tags: autoTag("25Q2") },
      { companyName: "HOWDEN JOYNERY", title: "25Q1", dateRead: "2025-08-29", tags: autoTag("25Q1") },
      { companyName: "GOOGLE", title: "25Q2", dateRead: "2025-08-26", tags: autoTag("25Q2") },
      { companyName: "SIEMENS EMERGY", title: "25Q2 j", dateRead: "2025-08-25", tags: autoTag("25Q2 j") },
      { companyName: "NOVO NORDISK", title: "25Q2", dateRead: "2025-08-22", tags: autoTag("25Q2") },
      { companyName: "GE VERNOVA", title: "25Q2", dateRead: "2025-08-06", tags: autoTag("25Q2") },
      { companyName: "ELI LILLY", title: "250623 special call", dateRead: "2025-08-05", tags: autoTag("250623 special call") },
      { companyName: "TSMC", title: "25Q3", dateRead: "2025-10-29", tags: autoTag("25Q3") },
      { companyName: "AKER BP", title: "25Q3", dateRead: "2025-10-29", tags: autoTag("25Q3") },
      { companyName: "MICRON", title: "25Q4", dateRead: "2025-10-28", tags: autoTag("25Q4") },
      { companyName: "EVOLUTION", title: "25Q3", dateRead: "2025-10-25", tags: autoTag("25Q3") },
      { companyName: "LVMH", title: "25H01", dateRead: "2025-10-19", tags: autoTag("25H01") },
    ];

    // ========== STATE ==========
    let reports = [];
    let selectedCompany = null;
    let isAllReportsVisible = false;
    let confirmDeleteId = null;
    let filteredByTag = null;

    async function initializeReports() {
      if (gistStorage.syncEnabled) {
        const gistData = await gistStorage.loadFromGist();
        if (gistData && gistData.length > 0) {
          reports = gistData;
          localStorage.setItem('reports', JSON.stringify(reports));
          return;
        }
      }
      
      const localData = JSON.parse(localStorage.getItem('reports'));
      if (localData && localData.length > 0) {
        reports = localData;
      } else {
        reports = PRELOADED_REPORTS.map(r => ({ ...r, id: generateId() }));
        await saveReports();
      }
    }

    // DOM
    const modal = document.getElementById('modal');
    const setupModal = document.getElementById('setup-modal');
    const modalMessage = document.getElementById('modal-message');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    const okBtn = document.getElementById('modal-ok');
    const addReportForm = document.getElementById('addReportForm');
    const companyNameInput = document.getElementById('companyName');
    const reportTitleInput = document.getElementById('reportTitle');
    const reportTagsInput = document.getElementById('reportTags');
    const dateReadInput = document.getElementById('dateRead');
    const autocompleteList = document.getElementById('autocomplete-list');
    const tagCloudEl = document.getElementById('tag-cloud');

    const today = new Date().toISOString().split('T')[0];
    dateReadInput.value = today;

    // ========== UTILS ==========
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    async function saveReports() {
      localStorage.setItem('reports', JSON.stringify(reports));
      if (gistStorage.syncEnabled) {
        await gistStorage.saveToGist(reports);
      } else {
        updateSyncStatus('synced', 'Local Mode');
      }
    }

    function showCustomModal(message, isConfirm = false) {
      modalMessage.textContent = message;
      confirmDeleteBtn.style.display = isConfirm ? 'inline-flex' : 'none';
      cancelDeleteBtn.style.display = isConfirm ? 'inline-flex' : 'none';
      okBtn.style.display = isConfirm ? 'none' : 'inline-flex';
      modal.classList.remove('hidden');
    }

    function closeModal() {
      modal.classList.add('hidden');
      confirmDeleteId = null;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
      }[m]));
    }

    function renderTags(tags) {
      if (!tags || tags.length === 0) return '';
      return tags.map(tag => 
        `<span class="tag-badge ${getTagColor(tag)}">${escapeHtml(tag)}</span>`
      ).join('');
    }

    function getUniqueCompanies() {
      const names = new Set(reports.map(r => r.companyName.toUpperCase()));
      return Array.from(names).sort();
    }

    function getAllTags() {
      const tags = new Set();
      reports.forEach(r => {
        if (r.tags) r.tags.forEach(t => tags.add(t));
      });
      return Array.from(tags).sort();
    }

    // ========== AUTOCOMPLETE ==========
    let selectedIndex = -1;
    let suggestions = [];

    function showSuggestions(inputValue) {
      const uniqueCompanies = getUniqueCompanies();
      suggestions = uniqueCompanies.filter(company =>
        company.toLowerCase().includes(inputValue.toLowerCase())
      );
      if (suggestions.length === 0 || !inputValue.trim()) {
        autocompleteList.classList.add('hidden');
        return;
      }
      autocompleteList.innerHTML = suggestions.map((company, idx) =>
        `<div class="autocomplete-item" data-index="${idx}">${escapeHtml(company)}</div>`
      ).join('');
      autocompleteList.classList.remove('hidden');
      selectedIndex = -1;
    }

    function selectSuggestion(index) {
      if (index >= 0 && index < suggestions.length) {
        companyNameInput.value = suggestions[index];
        hideSuggestions();
        companyNameInput.focus();
      }
    }

    function hideSuggestions() {
      autocompleteList.classList.add('hidden');
      selectedIndex = -1;
    }

    companyNameInput.addEventListener('input', () => {
      selectedIndex = -1;
      showSuggestions(companyNameInput.value);
    });

    companyNameInput.addEventListener('keydown', (e) => {
      const items = autocompleteList.querySelectorAll('.autocomplete-item');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        selectSuggestion(selectedIndex);
        return;
      } else if (e.key === 'Escape') {
        hideSuggestions();
        return;
      }
      items.forEach((item, idx) => {
        item.classList.toggle('selected', idx === selectedIndex);
      });
    });

    autocompleteList.addEventListener('click', (e) => {
      if (e.target.classList.contains('autocomplete-item')) {
        const index = parseInt(e.target.getAttribute('data-index'), 10);
        selectSuggestion(index);
      }
    });

    document.addEventListener('click', (e) => {
      if (!companyNameInput.contains(e.target) && !autocompleteList.contains(e.target)) {
        hideSuggestions();
      }
    });

    // ========== EDIT REPORT ==========
    function editReport(reportId) {
      const report = reports.find(r => r.id === reportId);
      if (!report) return;

      const row = document.querySelector(`tr[data-id="${reportId}"]`);
      if (!row) return;

      const originalHtml = row.innerHTML;
      row.classList.add('bg-amber-50');
      row.innerHTML = `
        <td colspan="5" class="px-6 py-4">
          <div class="edit-form">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <input type="text" value="${escapeHtml(report.companyName)}" class="edit-company px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
              <input type="text" value="${escapeHtml(report.title)}" class="edit-title px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
              <input type="text" value="${report.tags ? report.tags.join(', ') : ''}" class="edit-tags px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Tags" />
              <input type="date" value="${report.dateRead}" class="edit-date px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
            </div>
            <div class="mt-3 flex gap-2">
              <button class="save-edit bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">üíæ Save</button>
              <button class="cancel-edit bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">‚úï Cancel</button>
            </div>
          </div>
        </td>
      `;

      const saveBtn = row.querySelector('.save-edit');
      const cancelBtn = row.querySelector('.cancel-edit');

      saveBtn.addEventListener('click', async () => {
        const company = row.querySelector('.edit-company').value.trim();
        const title = row.querySelector('.edit-title').value.trim();
        const tagsStr = row.querySelector('.edit-tags').value.trim();
        const date = row.querySelector('.edit-date').value;

        if (!company || !title || !date) {
          showCustomModal('All fields required.');
          return;
        }

        const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

        const index = reports.findIndex(r => r.id === reportId);
        if (index !== -1) {
          reports[index] = { ...reports[index], companyName: company, title, tags, dateRead: date };
          await saveReports();
          render();
        }
      });

      cancelBtn.addEventListener('click', () => {
        row.innerHTML = originalHtml;
        row.classList.remove('bg-amber-50');
        const deleteBtn = row.querySelector('button[onclick]');
        if (deleteBtn) {
          deleteBtn.onclick = () => handleDeleteClick(reportId);
        }
      });
    }

    // ========== RENDERING ==========
    function computeCompanyData() {
      const data = {};
      const now = new Date();
      const filteredReports = filteredByTag 
        ? reports.filter(r => r.tags && r.tags.includes(filteredByTag))
        : reports;

      filteredReports.forEach(report => {
        const key = report.companyName.toUpperCase();
        if (!data[key]) {
          const lastDate = new Date(report.dateRead);
          const diffTime = now - lastDate;
          const days = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          data[key] = { count: 1, daysSinceLastReport: days };
        } else {
          data[key].count++;
        }
      });
      return Object.entries(data).sort(([,a], [,b]) => b.count - a.count);
    }

    function renderTagCloud() {
      const allTags = getAllTags();
      if (allTags.length === 0) {
        tagCloudEl.innerHTML = '<p class="text-slate-500 text-sm">No tags yet</p>';
        return;
      }
      tagCloudEl.innerHTML = allTags.map(tag => 
        `<span class="tag-cloud-item ${getTagColor(tag)} text-white" onclick="filterByTag('${escapeHtml(tag)}')">${escapeHtml(tag)} (${reports.filter(r => r.tags && r.tags.includes(tag)).length})</span>`
      ).join('');
    }

    function render() {
      const totalReportsCount = reports.length;
      document.getElementById('total-count').textContent = totalReportsCount;

      let displayedReports = reports;
      if (filteredByTag) {
        displayedReports = reports.filter(r => r.tags && r.tags.includes(filteredByTag));
      }

      const lastThreeReports = displayedReports
        .slice()
        .sort((a, b) => new Date(b.dateRead) - new Date(a.dateRead))
        .slice(0, 3);

      const last3Container = document.getElementById('last-three-container');
      if (lastThreeReports.length > 0) {
        last3Container.innerHTML = lastThreeReports.map(report => `
          <div class="flex items-start space-x-3 p-4 rounded-xl border-l-4 border-indigo-500 bg-gradient-to-r from-slate-50 to-white shadow-sm hover:shadow-md transition-shadow">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-indigo-500 w-5 h-5 mt-1 flex-shrink-0">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-semibold text-slate-900 leading-tight truncate">${escapeHtml(report.title)}</p>
              <p class="text-xs text-slate-600 mt-1 font-medium">${escapeHtml(report.companyName)}</p>
              <div class="flex flex-wrap items-center text-xs mt-2">
                ${renderTags(report.tags)}
              </div>
              <div class="flex items-center text-xs text-slate-500 mt-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-1">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                ${report.dateRead}
              </div>
            </div>
          </div>
        `).join('');
      } else {
        last3Container.innerHTML = '<p class="text-slate-500 text-sm">No recent reports found.</p>';
      }

      renderTagCloud();

      const mainDisplay = document.getElementById('main-display');
      if (selectedCompany) {
        const filtered = displayedReports.filter(r => r.companyName.toUpperCase() === selectedCompany);
        renderReportsTable(filtered, `Reports for ${selectedCompany}`, () => {
          selectedCompany = null;
          filteredByTag = null;
          render();
        });
      } else if (isAllReportsVisible) {
        renderReportsTable(displayedReports, 'All Reports', () => {
          isAllReportsVisible = false;
          filteredByTag = null;
          document.getElementById('toggle-all').textContent = 'Show All Reports';
          render();
        });
      } else {
        renderCompanyList(computeCompanyData());
      }
    }

    function renderCompanyList(companyData) {
      const container = document.getElementById('main-display');
      if (companyData.length === 0) {
        container.innerHTML = `
          <div class="text-center text-slate-500 py-16">
            <svg class="mx-auto h-16 w-16 text-slate-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-lg font-medium">No companies registered yet</p>
            <p class="text-sm mt-2">Add your first report above to get started!</p>
          </div>
        `;
        return;
      }

      const total = companyData.length;
      const greenThresh = Math.floor(total * 0.20);
      const blueThresh = Math.floor(total * 0.70);

      container.innerHTML = `
        <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-5">
          ${companyData.map(([company, info], idx) => {
            let border = 'border-slate-300';
            let badge = 'bg-slate-100 text-slate-600';
            if (idx < greenThresh) {
              border = 'border-emerald-500';
              badge = 'bg-emerald-100 text-emerald-700';
            } else if (idx < blueThresh) {
              border = 'border-sky-500';
              badge = 'bg-sky-100 text-sky-700';
            }

            const daysText = info.daysSinceLastReport > 0
              ? `${info.daysSinceLastReport} days ago`
              : info.daysSinceLastReport === 0 ? 'üî• Today' : 'Future';

            return `
              <div class="company-card bg-white rounded-xl shadow-md border-t-4 ${border} overflow-hidden cursor-pointer"
                   onclick="selectCompany('${escapeHtml(company)}')">
                <div class="p-6">
                  <div class="flex items-start justify-between mb-3">
                    <h3 class="font-bold text-slate-900 text-lg leading-tight flex-1 mr-2">${escapeHtml(company)}</h3>
                    <div class="flex items-center text-xs font-bold ${badge} px-2.5 py-1.5 rounded-full whitespace-nowrap">
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-1">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                      </svg>
                      ${info.count}
                    </div>
                  </div>
                  <p class="text-sm text-slate-600 font-medium">üìÖ ${daysText}</p>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderReportsTable(reportsToDisplay, title, onBack) {
      const sorted = reportsToDisplay.slice().sort((a, b) => new Date(b.dateRead) - new Date(a.dateRead));
      const container = document.getElementById('main-display');
      container.innerHTML = `
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
            <h2 class="text-3xl font-bold text-slate-800">${escapeHtml(title)}</h2>
            <button onclick="backFromReports()"
              class="flex items-center bg-white border-2 border-slate-300 hover:bg-slate-50 text-slate-700 font-semibold py-2.5 px-5 rounded-xl shadow-sm transition-all hover:shadow-md">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="mr-2 h-5 w-5">
                <path d="M21 11H6.83L10.41 7.41L9 6L3 12L9 18L10.41 16.59L6.83 13H21V11Z"></path>
              </svg>
              Back
            </button>
          </div>
          <div class="overflow-x-auto rounded-lg border border-slate-200">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-700 uppercase tracking-wider">Company</th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-700 uppercase tracking-wider">Title</th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-700 uppercase tracking-wider">Tags</th>
                  <th class="px-6 py-4 text-left text-xs font-bold text-slate-700 uppercase tracking-wider">Date</th>
                  <th class="px-6 py-4 text-center text-xs font-bold text-slate-700 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-slate-100">
                ${sorted.map(report => `
                  <tr data-id="${report.id}" class="hover:bg-slate-50 transition-colors duration-150 cursor-pointer" onclick="editReport('${report.id}')">
                    <td class="px-6 py-4 text-sm font-semibold text-slate-900">${escapeHtml(report.companyName)}</td>
                    <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(report.title)}</td>
                    <td class="px-6 py-4 text-sm">
                      ${renderTags(report.tags)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 font-medium">${report.dateRead}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                      <button type="button" onclick="event.stopPropagation(); handleDeleteClick('${report.id}')" class="text-slate-400 hover:text-red-600 transition-colors duration-150" aria-label="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5 mx-auto">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          <line x1="10" y1="11" x2="10" y2="17"></line>
                          <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ========== GLOBAL FUNCTIONS ==========
    window.selectCompany = function(company) {
      selectedCompany = company;
      filteredByTag = null;
      render();
    };

    window.handleDeleteClick = function(reportId) {
      confirmDeleteId = reportId;
      showCustomModal('Are you sure you want to delete this report?', true);
    };

    window.backFromReports = function() {
      selectedCompany = null;
      isAllReportsVisible = false;
      filteredByTag = null;
      document.getElementById('toggle-all').textContent = 'Show All Reports';
      render();
    };

    window.filterByTag = function(tag) {
      filteredByTag = tag;
      selectedCompany = null;
      isAllReportsVisible = true;
      render();
    };

    // ========== EVENT LISTENERS ==========
    addReportForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const cn = companyNameInput.value.trim();
      const rt = reportTitleInput.value.trim();
      const tagsInput = reportTagsInput.value.trim();
      const dr = dateReadInput.value;
      if (!cn || !rt || !dr) {
        showCustomModal('Please fill in all fields.');
        return;
      }

      const tags = tagsInput
        ? tagsInput.split(',').map(t => t.trim()).filter(t => t)
        : [];

      reports.push({
        id: generateId(),
        companyName: cn.toUpperCase(),
        title: rt,
        tags: tags,
        dateRead: dr
      });
      await saveReports();
      companyNameInput.value = '';
      reportTitleInput.value = '';
      reportTagsInput.value = '';
      dateReadInput.value = today;
      hideSuggestions();
      render();
    });

    document.getElementById('toggle-all').addEventListener('click', () => {
      isAllReportsVisible = !isAllReportsVisible;
      document.getElementById('toggle-all').textContent = isAllReportsVisible ? 'Hide All Reports' : 'Show All Reports';
      if (!isAllReportsVisible) filteredByTag = null;
      render();
    });

    document.getElementById('export-json').addEventListener('click', () => {
      if (reports.length === 0) {
        showCustomModal('There are no reports to export.');
        return;
      }
      const jsonString = JSON.stringify(reports, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `financial-reports-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    document.getElementById('import-json').addEventListener('click', () => {
      document.getElementById('import-file').click();
    });

    document.getElementById('import-file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const importedReports = JSON.parse(text);
        
        if (!Array.isArray(importedReports)) {
          showCustomModal('Invalid JSON format. Expected an array of reports.');
          return;
        }
        
        reports = importedReports.map(r => ({
          id: r.id || generateId(),
          companyName: r.companyName || '',
          title: r.title || '',
          tags: r.tags || [],
          dateRead: r.dateRead || ''
        }));
        
        await saveReports();
        render();
        showCustomModal(`Successfully imported ${reports.length} reports!`);
      } catch (error) {
        showCustomModal('Error reading file. Please ensure it\'s a valid JSON file.');
      }
      e.target.value = '';
    });

    document.getElementById('setup-github-btn').addEventListener('click', () => {
      document.getElementById('github-token').value = gistStorage.token;
      document.getElementById('gist-id').value = gistStorage.gistId;
      setupModal.classList.remove('hidden');
    });

    document.getElementById('save-github-config').addEventListener('click', async () => {
      const token = document.getElementById('github-token').value.trim();
      const gistId = document.getElementById('gist-id').value.trim();
      
      if (!token) {
        showCustomModal('Please enter a GitHub token.');
        return;
      }
      
      gistStorage.configure(token, gistId);
      setupModal.classList.add('hidden');
      
      updateSyncStatus('syncing', 'Syncing...');
      
      if (gistId) {
        const gistData = await gistStorage.loadFromGist();
        if (gistData) {
          reports = gistData;
          localStorage.setItem('reports', JSON.stringify(reports));
        }
      } else {
        await gistStorage.saveToGist(reports);
      }
      
      render();
      showCustomModal('GitHub sync configured successfully!');
    });

    document.getElementById('cancel-setup').addEventListener('click', () => {
      setupModal.classList.add('hidden');
    });

    confirmDeleteBtn.addEventListener('click', async () => {
      if (!confirmDeleteId) return;
      reports = reports.filter(r => r.id !== confirmDeleteId);
      await saveReports();
      closeModal();
      render();
    });

    cancelDeleteBtn.addEventListener('click', closeModal);
    okBtn.addEventListener('click', closeModal);

    // Initial load
    (async () => {
      await initializeReports();
      if (gistStorage.syncEnabled) {
        updateSyncStatus('synced', 'GitHub Synced');
      } else {
        updateSyncStatus('synced', 'Local Mode');
      }
      render();
    })();
  </script>
</body>
</html>

